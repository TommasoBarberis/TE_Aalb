Bootstrap: docker
from: mysql:5.7.21

%labels
    AUTHOR Tommaso Barberis tommasobarberis98@gmail.com
    VERSION  v1.0.0

%post
    cd /opt 

    apt-get update
    apt-get install -y --allow-unauthenticated \
        python-pip \
        libmysqlclient-dev \
        wget \
        hmmer

    ## Download PASTEC
    wget https://urgi.versailles.inrae.fr/download/repet/PASTEC_linux-x64-2.0.tar.gz
    tar -xvf PASTEC_linux-x64-2.0.tar.gz

    ## Fix on PASTEC modules
    for pkg in $(ls -d /opt/PASTEC_linux-x64-2.0/*/); do
        for module in $(ls -1 $pkg/*py); do
            sed 's/from commons./from /g' $module > tmp && cat tmp > $module && rm tmp
            sed 's/from PASTEC./from /g' $module > tmp && cat tmp > $module && rm tmp
        done
    done 2> /dev/null

    ## Installing dependancies of PASTEC
    # apt-get install -y \
    #     python3-apt \
    #     build-essential \
    #     default-libmysqlclient-dev 
       
    # wget http://ftp.de.debian.org/debian/pool/main/g/glibc/libc6_2.28-10+deb10u1_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/o/openssl/libssl1.1_1.1.1n-0+deb10u1_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/p/python3.7/libpython3.7-minimal_3.7.3-2+deb10u3_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/p/python3.7/python3.7-minimal_3.7.3-2+deb10u3_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/p/python3-defaults/python3-minimal_3.7.3-1_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/n/ncurses/libtinfo6_6.1+20181013-2+deb10u2_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/n/ncurses/libncursesw6_6.1+20181013-2+deb10u2_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/p/python3.7/libpython3.7-stdlib_3.7.3-2+deb10u3_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/p/python3.7/python3.7_3.7.3-2+deb10u3_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/p/python3-defaults/libpython3-stdlib_3.7.3-1_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/p/python3-defaults/python3_3.7.3-1_amd64.deb
    # wget http://ftp.de.debian.org/debian/pool/main/p/python3-stdlib-extensions/python3-lib2to3_3.7.3-1_all.deb
    
    # wget http://ftp.de.debian.org/debian/pool/main/libx/libxcrypt/libcrypt1_4.4.18-4_amd64.deb

    # wget http://ftp.de.debian.org/debian/pool/main/g/glibc/libc6_2.31-13+deb11u3_amd64.deb

    # wget http://ftp.de.debian.org/debian/pool/main/p/python3.9/python3.9-minimal_3.9.2-1_amd64.deb

    # wget http://ftp.de.debian.org/debian/pool/main/p/python3-defaults/python3-minimal_3.9.2-3_amd64.deb

    # wget http://ftp.de.debian.org/debian/pool/main/p/python3-defaults/python3_3.9.2-3_amd64.deb

    # wget http://ftp.de.debian.org/debian/pool/main/p/python3-stdlib-extensions/python3-distutils_3.9.2-1_all.deb
    # wget http://ftp.de.debian.org/debian/pool/main/w/what-is-python/python-dev-is-python3_3.9.2-1_all.deb
    # wget http://security.ubuntu.com/ubuntu/pool/universe/p/python2.7/libpython2.7-minimal_2.7.18-1~20.04.1_amd64.deb
    # wget http://cz.archive.ubuntu.com/ubuntu/pool/main/m/mime-support/mime-support_3.64ubuntu1_all.deb
    # wget http://cz.archive.ubuntu.com/ubuntu/pool/main/r/readline/readline-common_8.0-4_all.deb
    # wget http://cz.archive.ubuntu.com/ubuntu/pool/main/r/readline/libreadline8_8.0-4_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/universe/p/python2.7/libpython2.7-stdlib_2.7.18-1~20.04.1_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/universe/p/python2.7/python2.7-minimal_2.7.18-1~20.04.1_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/universe/p/python2.7/python2.7_2.7.18-1~20.04.1_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/universe/p/python-pip/python-pip-whl_20.0.2-5ubuntu1.5_all.deb

    # dpkg -i libc6_2.28-10+deb10u1_amd64.deb
    # dpkg -i libssl1.1_1.1.1n-0+deb10u1_amd64.deb
    # dpkg -i libpython3.7-minimal_3.7.3-2+deb10u3_amd64.deb
    # dpkg -i python3.7-minimal_3.7.3-2+deb10u3_amd64.deb
    # dpkg -i python3-minimal_3.7.3-1_amd64.deb
    # dpkg -i libtinfo6_6.1+20181013-2+deb10u2_amd64.deb
    # dpkg -i libncursesw6_6.1+20181013-2+deb10u2_amd64.deb
    # dpkg -i libpython3.7-stdlib_3.7.3-2+deb10u3_amd64.deb
    # dpkg -i python3.7_3.7.3-2+deb10u3_amd64.deb
    # dpkg -i libpython3-stdlib_3.7.3-1_amd64.deb
    # dpkg -i python3_3.7.3-1_amd64.deb
    # dpkg -i python3-lib2to3_3.7.3-1_all.deb

    # dpkg -i libcrypt1_4.4.18-4_amd64.deb
    
    # dpkg -i libc6_2.31-13+deb11u3_amd64.deb

    # dpkg -i python3.9-minimal_3.9.2-1_amd64.deb

    # dpkg -i python3-minimal_3.9.2-3_amd64.deb

    # dpkg -i python3_3.9.2-3_amd64.deb

    # dpkg -i python3-distutils_3.9.2-1_all.deb
    # dpkg -i python-dev-is-python3_3.9.2-1_all.deb
    # dpkg -i libpython2.7-minimal_2.7.18-1~20.04.1_amd64.deb
    # dpkg -i mime-support_3.64ubuntu1_all.deb
    # dpkg -i readline-common_8.0-4_all.deb
    # dpkg -i libreadline8_8.0-4_amd64.deb
    # dpkg -i libpython2.7-stdlib_2.7.18-1~20.04.1_amd64.deb

    # dpkg -i python2.7-minimal_2.7.18-1~20.04.1_amd64.deb
    
    # dpkg -i python2.7_2.7.18-1~20.04.1_amd64.deb
    
    # dpkg -i python-pip-whl_20.0.2-5ubuntu1.5_all.deb
    
    ### Installin pip
    # cd /opt
    # wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
    # python2.7 get-pip.py

    ### Installing Python modules
    pip install PyYAML==5.4.1

    ### Installing MySQLdb
    cd /opt

    # wget http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc-dev-bin_2.31-0ubuntu9.7_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/universe/p/python2.7/libpython2.7_2.7.18-1~20.04.1_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.31-0ubuntu9.7_amd64.deb
    # wget http://cz.archive.ubuntu.com/ubuntu/pool/main/libx/libxcrypt/libcrypt-dev_4.4.10-10ubuntu4_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/main/l/linux/linux-libc-dev_5.4.0-105.119_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6-dev_2.31-0ubuntu9.7_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/main/e/expat/libexpat1_2.2.9-1ubuntu0.4_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/main/e/expat/libexpat1-dev_2.2.9-1ubuntu0.4_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/universe/p/python2.7/libpython2.7-dev_2.7.18-1~20.04.1_amd64.deb
    # wget http://security.ubuntu.com/ubuntu/pool/universe/p/python2.7/python2.7-dev_2.7.18-1~20.04.1_amd64.deb


    # dpkg -i libpython2.7_2.7.18-1~20.04.1_amd64.deb
    # dpkg -i libc-dev-bin_2.31-0ubuntu9.7_amd64.deb
    # dpkg -i libc6_2.31-0ubuntu9.7_amd64.deb
    # dpkg -i libcrypt-dev_4.4.10-10ubuntu4_amd64.deb
    # dpkg -i linux-libc-dev_5.4.0-105.119_amd64.deb
    # dpkg -i libc6-dev_2.31-0ubuntu9.7_amd64.deb 
    # dpkg -i libexpat1_2.2.9-1ubuntu0.4_amd64.deb
    # dpkg -i libexpat1-dev_2.2.9-1ubuntu0.4_amd64.deb 
    # dpkg -i libpython2.7-dev_2.7.18-1~20.04.1_amd64.deb
    # dpkg -i python2.7-dev_2.7.18-1~20.04.1_amd64.deb

    pip install mysqlclient==1.4.6


    ## Installing optional dependencies for PASTEC

    ### Installing BLAST+
    # cd /opt
    wget https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/2.13.0/ncbi-blast-2.13.0+-x64-linux.tar.gz
    tar -xvf ncbi-blast-2.13.0+-x64-linux.tar.gz

    ### Installing HMMER3
    # wget http://cz.archive.ubuntu.com/ubuntu/pool/universe/libd/libdivsufsort/libdivsufsort3_2.0.1-4_amd64.deb
    # wget http://cz.archive.ubuntu.com/ubuntu/pool/universe/h/hmmer/hmmer_3.3+dfsg2-1_amd64.deb
    
    # dpkg -i libdivsufsort3_2.0.1-4_amd64.deb
    # dpkg -i hmmer_3.3+dfsg2-1_amd64.deb

    ### Installing TRF
    # cd /opt
    wget https://github.com/Benson-Genomics-Lab/TRF/releases/download/v4.09.1/trf409.linux64
    chmod +x trf409.linux64

    ## Downloading Pfam
    # cd /media
    # wget https://urgi.versailles.inra.fr/download/repet/profiles/ProfilesBankForREPET_Pfam32.0.hmm.tar.gz
    # tar -xvf ProfilesBankForREPET_Pfam32.0.hmm.tar.gz

    # ## Setup PASTEC
    # sed 's/repet_host: <your_MySQL_host>/repet_host: mysql/g' /opt/PASTEC_linux-x64-2.0/config/PASTEClassifier.cfg | \
    # sed 's/repet_user: <your_MySQL_login>/repet_user: root/g' | \
    # sed "s/repet_pw: <your_MySQL_password>/repet_pw: $MYSQL_ROOT_PASSWORD/g" | \
    # sed 's/repet_db: <your_MySQL_db>/repet_db: mysql/g' | \
    # # sed 's/project_name: <your_project_name>/project_name: TE_classification/g' | \
    # sed 's/blast: ncbi/blast: ncbiplus/g' | \
    # sed "s~TE_HMM_profiles: <bank_of_HMM_profiles>~TE_HMM_profiles: /media/ProfilesBankForREPET_Pfam32.0.hmm~g" | \
    # > tmp && cat tmp > /opt/PASTEC_linux-x64-2.0/config/PASTEClassifier.cfg && rm tmp

    ## Clean
    cd /opt
    # rm *tar.gz *.deb

%environment
    export PATH=/opt/PASTEC_linux-x64-2.0/bin:$PATH
    export PATH=/opt/ncbi-blast-2.13.0+/bin:$PATH
    export PATH=/opt/:$PATH
    export REPET_PATH=/opt/PASTEC_linux-x64-2.0
    export PYTHONPATH=/opt/PASTEC_linux-x64-2.0/PASTEC:/opt/PASTEC_linux-x64-2.0/commons:/opt/PASTEC_linux-x64-2.0/PASTEC:/opt/PASTEC_linux-x64-2.0/PASTEC

#TODO
# README et expliquer comment configurer le fichier .cfg
%runscript
    touch /var/lib/mysql/write_test
    if [ ! -f /var/lib/mysql/write_test ]
    then
        echo '/var/lib/mysql is not writable.  Please see https://www.hpc.iastate.edu/guides/containers/mysql-server'
        echo 'for instructions on bind-mounting host directories into this container.'
        exit 1
    fi
    rm -f /var/lib/mysql/write_test

        # Check for initialization
    if [ ! -d /var/lib/mysql/mysql ]
    then
        echo "Initializing mysqld"
        mysqld --initialize-insecure
    fi

    # Finally, launch mysqld
    echo ""
    echo "Start mysqld"
    mysqld &

%help
Singularity container for PASTEC from the REPET package.